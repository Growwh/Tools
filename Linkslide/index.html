<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growwh LinkedIn Carousel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            padding: 20px;
            color: #270a47;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #270a47, #693ab7, #da3d72);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fafbfc;
            color: #2c3e50;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0a66c2;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(10, 102, 194, 0.08);
            transform: translateY(-1px);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .generate-btn {
            width: 100%;
            background: #693ab7;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 32px 0;
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(10, 102, 194, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-card {
            background: rgba(105, 58, 183, 0.1);
            border: 1px solid rgba(105, 58, 183, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 32px;
            position: relative;
        }
        
        .info-card::before {
            content: "üí°";
            font-size: 24px;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        
        .info-card .info-content {
            margin-left: 40px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .status-message {
            text-align: center;
            padding: 40px;
            border-radius: 16px;
            margin: 24px 0;
            font-weight: 600;
        }
        
        .loading {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: #64748b;
        }
        
        .error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border: 2px solid #f87171;
        }
        
        .success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #16a34a;
            border: 2px solid #4ade80;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(100, 116, 139, 0.2);
            border-top: 3px solid #64748b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .carousel-container {
            margin-top: 40px;
        }
        
        .carousel-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .carousel-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .carousel-slides {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .carousel-slide {
            width: 400px;
            height: 400px;
            background: #ffffff;
            color: #2c3e50;
            padding: 40px;
            border-radius: 0px; /* Default to no border radius */
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            margin: 0 auto;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }
        
        .slide-pattern {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%230a66c2' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Hide slide number on first slide */
        .carousel-slide:not(.first-slide) .slide-number {
            position: absolute;
            top: 24px;
            right: 24px;
            background: #0a66c2;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(10, 102, 194, 0.3);
        }
        
        .slide-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 2;
        }
        
        .slide-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 24px;
            line-height: 1.2;
            color: #0a66c2;
        }
        
        .slide-text {
            font-size: 16px;
            line-height: 1.6;
            font-weight: 400;
            color: #2c3e50;
        }
        
        .slide-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #e1e5e9;
            z-index: 2;
        }
        
        .slide-username {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .linkedin-icon {
            width: 18px;
            height: 18px;
            background: #0a66c2;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }
        
        .carousel-slide.first-slide {
            background: linear-gradient(135deg, #0a66c2, #004182);
            color: white;
        }
        
        .carousel-slide.first-slide .slide-title {
            color: white;
            font-size: 32px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .carousel-slide.first-slide .slide-text {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-size: 18px;
            font-weight: 500;
        }
        
        .carousel-slide.first-slide .slide-number {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .carousel-slide.first-slide .slide-footer {
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .carousel-slide.first-slide .slide-username {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .carousel-slide.first-slide .linkedin-icon {
            background: rgba(255, 255, 255, 0.9);
            color: #0a66c2;
        }
        
        .carousel-slide.first-slide .slide-logo {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Apply first slide styling to the last slide */
        .carousel-slide.last-slide {
            background: linear-gradient(135deg, #0a66c2, #004182); /* Inherit from first-slide */
            color: white;
        }
        
        .carousel-slide.last-slide .slide-title {
            color: white;
            text-align: center;
            font-size: 32px; /* Match first slide */
            margin-bottom: 30px; /* Match first slide */
        }
        
        .carousel-slide.last-slide .slide-text {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-size: 18px; /* Match first slide */
            font-weight: 500; /* Match first slide */
        }
        
        .carousel-slide.last-slide .slide-number {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .carousel-slide.last-slide .slide-footer {
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .carousel-slide.last-slide .slide-username {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .carousel-slide.last-slide .linkedin-icon {
            background: rgba(255, 255, 255, 0.9);
            color: #0a66c2;
        }

        /* Custom CTA for the first slide */
        .carousel-slide.first-slide .slide-footer .slide-username {
            position: absolute;
            bottom: 24px; /* Adjust as needed */
            right: 24px; /* Adjust as needed */
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Remove default username and logo from first slide footer */
        .carousel-slide.first-slide .slide-footer .slide-logo {
            display: none;
        }
        
        .carousel-slide.first-slide .slide-footer .slide-username .linkedin-icon {
            display: none;
        }
        
        .slide-logo {
            font-size: 10px;
            font-weight: 500;
            color: #94a3b8;
            font-style: italic;
        }
        
        .caption-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
        }
        
        .caption-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .caption-title::before {
            content: "‚úçÔ∏è";
            font-size: 20px;
        }
        
        .caption-text {
            font-size: 15px;
            line-height: 1.7;
            color: #475569;
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 32px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #da3d72, #5e407b);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .retry-section {
            text-align: center;
            margin-top: 24px;
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 12px;
        }
        
        .retry-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
        }
        
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 24px 20px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .form-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .carousel-slides {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .carousel-slide {
                width: 100%;
                max-width: 380px;
                height: 380px;
                padding: 32px 24px;
            }
            
            .slide-title {
                font-size: 22px;
                margin-bottom: 20px;
            }
            
            .slide-text {
                font-size: 15px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px 16px;
            }
            
            .header h1 {
                font-size: 1.9rem;
            }
            
            .carousel-slide {
                height: 350px;
                padding: 28px 20px;
            }
            
            .slide-title {
                font-size: 20px;
            }
            
            .slide-text {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ LinkedIn Carousel Generator</h1>
            <p>Create professional LinkedIn carousels that drive engagement and build your personal brand</p>
        </div>
        
        <div class="info-card">
            <div class="info-content">
                <strong>Pro Tip:</strong> Use specific, actionable topics and include your industry for best results. Each carousel will be optimized for LinkedIn's algorithm and professional audience.
            </div>
        </div>
        
        <div class="form-section">
            <div class="form-group">
                <label for="topic">üìù Topic/Theme *</label>
                <input type="text" id="topic" placeholder="e.g., 5 Digital Marketing Trends for 2025" required maxlength="100">
            </div>
            
            <div class="form-group">
                <label for="tone">üé≠ Tone *</label>
                <select id="tone" required>
                    <option value="">Select Tone</option>
                    <option value="professional">Professional</option>
                    <option value="casual">Casual & Friendly</option>
                    <option value="inspirational">Inspirational</option>
                    <option value="educational">Educational</option>
                    <option value="conversational">Conversational</option>
                    <option value="authoritative">Expert & Authoritative</option>
                    <option value="storytelling">Storytelling</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="industry">üè¢ Industry</label>
                <input type="text" id="industry" placeholder="e.g., Technology, Marketing, Finance" maxlength="50">
            </div>
            
            <div class="form-group">
                <label for="username">üë§ LinkedIn Username *</label>
                <input type="text" id="username" placeholder="@yourname" required maxlength="30">
            </div>
            
            <div class="form-group">
                <label for="slides">üìë Number of Slides</label>
                <select id="slides">
                    <option value="4">4 Slides</option>
                    <option value="5" selected>5 Slides</option>
                    <option value="6">6 Slides</option>
                    <option value="7">7 Slides</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="audience">üéØ Target Audience</label>
                <input type="text" id="audience" placeholder="e.g., Marketing professionals, Entrepreneurs" maxlength="100">
            </div>
            
            <div class="form-group full-width">
                <label for="keyPoints">üîë Key Points to Include (Optional)</label>
                <textarea id="keyPoints" placeholder="‚Ä¢ Specific statistics or data points&#10;‚Ä¢ Case studies or examples&#10;‚Ä¢ Actionable tips or strategies&#10;‚Ä¢ Any other key information..." maxlength="500"></textarea>
            </div>
        </div>
        
        <button class="generate-btn" onclick="generateCarousel()">
            Generate
        </button>
        
        <div id="resultContainer"></div>
    </div>
    
    <script>
        let currentCarouselData = null;
        let isGenerating = false;
        
        // Input validation and formatting
        document.getElementById('username').addEventListener('input', function() {
            let value = this.value.trim();
            if (value && !value.startsWith('@')) {
                this.value = '@' + value.replace(/^@+/, '');
            }
        });
        
        // Character counters for inputs
        const inputsWithLimits = ['topic', 'industry', 'username', 'audience', 'keyPoints'];
        inputsWithLimits.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function() {
                    const maxLength = this.getAttribute('maxlength');
                    if (maxLength && this.value.length > maxLength) {
                        this.value = this.value.substring(0, maxLength);
                    }
                });
            }
        });
        
        function showToast(message, type = 'success') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function showStatus(type, title, message, showRetry = false) {
            const resultContainer = document.getElementById('resultContainer');
            
            let content = `
                <div class="status-message ${type}">
                    <div style="font-size: 48px; margin-bottom: 16px;">
                        ${type === 'loading' ? '‚è≥' : type === 'error' ? '‚ùå' : '‚úÖ'}
                    </div>
                    <div style="font-size: 20px; margin-bottom: 8px;">${title}</div>
                    <div style="font-size: 16px; opacity: 0.8;">${message}</div>
            `;
            
            if (type === 'loading') {
                content += '<div class="loading-spinner"></div>';
            }
            
            if (showRetry) {
                content += `
                    <div class="retry-section">
                        <button class="retry-btn" onclick="generateCarousel()">üîÑ Try Again</button>
                        <button class="clear-btn" onclick="clearResults()">üßπ Start Over</button>
                    </div>
                `;
            }
            
            content += '</div>';
            resultContainer.innerHTML = content;
        }
        
        function clearResults() {
            document.getElementById('resultContainer').innerHTML = '';
            currentCarouselData = null;
            
            // Reset form
            document.getElementById('topic').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('industry').value = '';
            document.getElementById('username').value = '';
            document.getElementById('slides').value = '5';
            document.getElementById('audience').value = '';
            document.getElementById('keyPoints').value = '';
            
            showToast('Form cleared! Ready to create a new carousel.', 'success');
        }
        
        async function callTextAPI(prompt, retries = 3) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {

                    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent", {
                        method: "POST",
                        headers: {
                            "x-goog-api-key": `AIzaSyDrZLC0L7QzD1slUQhvCGa6DuE9hFskqJo`, // <-- make sure API_KEY is defined
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API responded with status: ${response.status}`);
                    }


                    const raw = await response.json();


                    if (!raw?.candidates?.length || !raw.candidates[0]?.content?.parts?.length) {
                        throw new Error("Invalid API response format");
                    }

                    let text = raw.candidates[0].content.parts[0].text.trim();
                    text = text.replace(/```json|```/g, "").trim();
                    
                    return text;
                    
                } catch (error) {
                    console.error(`API attempt ${attempt} failed:`, error);
                    
                    if (attempt === retries) {
                        throw new Error(`Failed after ${retries} attempts: ${error.message}`);
                    }
                    
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }
        
        async function generateCarousel() {
            if (isGenerating) {
                showToast('Generation already in progress. Please wait...', 'error');
                return;
            }
            
            const topic = document.getElementById('topic').value.trim();
            const tone = document.getElementById('tone').value;
            const industry = document.getElementById('industry').value.trim();
            const username = document.getElementById('username').value.trim();
            const slideCount = parseInt(document.getElementById('slides').value);
            const audience = document.getElementById('audience').value.trim();
            const keyPoints = document.getElementById('keyPoints').value.trim();
            const generateBtn = document.querySelector('.generate-btn');
            
            // Validate required fields
            if (!topic) {
                showToast('Please enter a topic for your carousel.', 'error');
                document.getElementById('topic').focus();
                return;
            }
            
            if (!tone) {
                showToast('Please select a tone for your carousel.', 'error');
                document.getElementById('tone').focus();
                return;
            }
            
            if (!username) {
                showToast('Please enter your LinkedIn username.', 'error');
                document.getElementById('username').focus();
                return;
            }
            
            if (topic.length < 10) {
                showToast('Please provide a more detailed topic (at least 10 characters).', 'error');
                document.getElementById('topic').focus();
                return;
            }
            
            isGenerating = true;
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating Your Carousel...';
            
            showStatus('loading', 'Creating Your Carousel', 'Our AI is crafting engaging content tailored to your specifications. This may take up to 60 seconds...');
            
            try {
                // Build comprehensive prompt
                let contentPrompt = `Create a ${slideCount}-slide LinkedIn carousel about "${topic}". 

REQUIREMENTS:
- Tone: ${tone}
- ${industry ? `Industry focus: ${industry}` : 'General professional audience'}
- ${audience ? `Target audience: ${audience}` : 'LinkedIn professional network'}
- ${keyPoints ? `Must include these key points: ${keyPoints}` : ''}

SLIDE STRUCTURE:
- Slide 1: Eye-catching hook/title slide that grabs attention (make it compelling and curiosity-driven)
- Middle slides (2-${slideCount-1}): Valuable insights, tips, data points, or actionable advice
- Final slide (${slideCount}): MUST be engagement-focused with call-to-action like "What's your experience?", "Share your thoughts", "Which tip will you try first?", etc.

IMPORTANT FOR LAST SLIDE:
- Always end with an engaging question or call-to-action
- Encourage comments, shares, or discussion
- Examples: "What's your biggest challenge with [topic]?", "Which strategy has worked best for you?", "Share your experience in the comments!"

OUTPUT FORMAT (JSON only):
{
    "slides": [
        {
            "title": "Attention-grabbing title (max 50 chars)",
            "content": "Engaging content (max 120 chars per slide)"
        }
    ],
    "caption": "Professional LinkedIn post caption with 5-7 relevant hashtags and engaging copy that encourages interaction"
}

Make each slide concise, actionable, and valuable. The first slide should hook readers, middle slides provide value, and the last slide MUST drive engagement.`;
                
                const response = await callTextAPI(contentPrompt);
                
                // Parse the API response
                let carouselData;
                try {
                    // Clean the response
                    let cleanResponse = response.trim();
                    
                    // Remove markdown code blocks
                    cleanResponse = cleanResponse.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                    
                    // Find JSON object
                    const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        carouselData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No valid JSON found in response');
                    }
                    
                    // Validate required structure
                    if (!carouselData.slides || !Array.isArray(carouselData.slides)) {
                        throw new Error('Invalid carousel structure');
                    }
                    
                    // Ensure we have the right number of slides
                    if (carouselData.slides.length !== slideCount) {
                        // Adjust slides to match requested count
                        while (carouselData.slides.length < slideCount) {
                            carouselData.slides.push({
                                title: `Point ${carouselData.slides.length + 1}`,
                                content: `Additional insight about ${topic}`
                            });
                        }
                        carouselData.slides = carouselData.slides.slice(0, slideCount);
                    }
                    
                    // Ensure caption exists
                    if (!carouselData.caption) {
                        carouselData.caption = `Sharing insights about ${topic}! üí°\n\nWhat are your thoughts? Share in the comments below! üëá\n\n#LinkedIn #ProfessionalGrowth #${topic.replace(/\s+/g, '')} #CareerTips #Leadership #Business`;
                    }
                    
                } catch (parseError) {
                    console.error('JSON parsing failed:', parseError);
                    // Create fallback content
                    carouselData = createFallbackCarousel(topic, slideCount, tone, industry);
                }
                
                currentCarouselData = carouselData;
                renderCarousel(carouselData, username);
                
                showToast('üéâ Your LinkedIn carousel is ready!', 'success');
                
            } catch (error) {
                console.error('Generation error:', error);
                
                let errorMessage = 'We encountered an issue generating your carousel.';
                if (error.message.includes('Failed after')) {
                    errorMessage = 'Our AI service is temporarily busy. Please try again in a moment.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network connection issue. Please check your internet and try again.';
                }
                
                showStatus('error', 'Generation Failed', errorMessage, true);
                showToast('Failed to generate carousel. Please try again.', 'error');
                
            } finally {
                isGenerating = false;
                generateBtn.disabled = false;
                generateBtn.textContent = 'üöÄ Generate LinkedIn Carousel';
            }
        }
        
        function createFallbackCarousel(topic, slideCount, tone, industry) {
            const slides = [
                {
                    title: topic,
                    content: "Let's dive into this important topic and explore key insights together."
                }
            ];
            
            // Add content slides
            for (let i = 1; i < slideCount - 1; i++) {
                slides.push({
                    title: `Key Point ${i}`,
                    content: `Important insight ${i} about ${topic} that professionals should know.`
                });
            }
            
            // Add conclusion slide with engagement focus
            slides.push({
                title: "Your Turn!",
                content: "What's your experience with this topic? Share your thoughts in the comments below! üëá"
            });
            
            return {
                slides: slides,
                caption: `Sharing insights about ${topic}! üí°\n\nWhat are your thoughts? Let's discuss in the comments! üëá\n\n#LinkedIn #ProfessionalGrowth #${topic.replace(/\s+/g, '')} #CareerTips #Leadership #Business`
            };
        }
        
        function renderCarousel(data, username) {
            const resultContainer = document.getElementById('resultContainer');
            
            let slidesHTML = '';
            data.slides.forEach((slide, index) => {
                const isFirst = index === 0;
                const isLast = index === data.slides.length - 1;
                let slideClass = 'carousel-slide';
                
                if (isFirst) slideClass += ' first-slide';
                if (isLast) slideClass += ' last-slide';
                
                slidesHTML += `
                    <div class="${slideClass}" id="slide-${index}" data-slide-index="${index}">
                        <div class="slide-pattern"></div>
                        ${!isFirst ? `<div class="slide-number">${index + 1}/${data.slides.length}</div>` : ''}
                        <div class="slide-content">
                            <div class="slide-title">${slide.title}</div>
                            <div class="slide-text">${slide.content}</div>
                        </div>
                        <div class="slide-footer">
                            ${isFirst ? `
                                <div class="slide-username">
                                    <div class="linkedin-icon">in</div>
                                    Swipe right to read
                                </div>` : `
                                <div class="slide-username">
                                    <div class="linkedin-icon">in</div>
                                    ${username.replace('@', '')}
                                </div>
                                <div class="slide-logo">Powered by Growwh.com</div>
                            `}
                        </div>
                    </div>
                `;
            });
            
            resultContainer.innerHTML = `
                <div class="carousel-container">
                    <div class="carousel-header">
                        <h2>‚ú® Your LinkedIn Carousel</h2>
                        <p>Professional carousel ready for LinkedIn posting</p>
                    </div>
                    
                    <div class="carousel-slides">
                        ${slidesHTML}
                    </div>
                    
                    <div class="caption-section">
                        <div class="caption-title">Suggested LinkedIn Caption</div>
                        <div class="caption-text" id="captionText">${data.caption}</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" onclick="downloadAllImages()">
                            üì∏ Download Images
                        </button>
                        <button class="action-btn" onclick="downloadAsPDF()">
                            üìÑ Download PDF
                        </button>
                        <button class="action-btn" onclick="copyCaption()">
                            üìã Copy Caption
                        </button>
                        <button class="action-btn" onclick="generateCarousel()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            üîÑ Generate New
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function downloadAllImages() {
            if (!currentCarouselData) {
                showToast('No carousel data available for download.', 'error');
                return;
            }
            
            const slides = document.querySelectorAll('.carousel-slide');
            const downloadBtn = document.querySelector('.action-btn');
            const originalText = downloadBtn.textContent;
            
            try {
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'Preparing Images...';
                
                for (let i = 0; i < slides.length; i++) {
                    const slide = slides[i];
                    
                    try {
                        // Create high-quality canvas
                        const canvas = await html2canvas(slide, {
                            backgroundColor: '#ffffff',
                            scale: 3, // Higher resolution
                            width: 400,
                            height: 400,
                            useCORS: true,
                            logging: false,
                            removeContainer: true,
                            allowTaint: true,
                            onclone: (clonedDoc) => {
                                // Ensure fonts are loaded and remove any border radius
                                const clonedSlide = clonedDoc.querySelector(`[data-slide-index="${i}"]`);
                                if (clonedSlide) {
                                    clonedSlide.style.fontFamily = 'Inter, system-ui, -apple-system, sans-serif';
                                    clonedSlide.style.borderRadius = '0px';
                                    clonedSlide.style.overflow = 'visible';
                                }
                            }
                        });
                        
                        // Convert to blob for better quality
                        const blob = await new Promise(resolve => {
                            canvas.toBlob(resolve, 'image/png', 1.0);
                        });
                        
                        // Create download link
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `LinkedIn-Carousel-Slide-${String(i + 1).padStart(2, '0')}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        // Update progress
                        downloadBtn.textContent = `Downloaded ${i + 1}/${slides.length} images...`;
                        
                        // Small delay between downloads to prevent overwhelming the browser
                        if (i < slides.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 800));
                        }
                        
                    } catch (error) {
                        console.error(`Error downloading slide ${i + 1}:`, error);
                        showToast(`Failed to download slide ${i + 1}`, 'error');
                    }
                }
                
                showToast(`üéâ Successfully downloaded ${slides.length} images!`, 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download images. Please try again.', 'error');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        }
        
        async function downloadAsPDF() {
            if (!currentCarouselData) {
                showToast('No carousel data available for PDF export.', 'error');
                return;
            }
            
            const slides = document.querySelectorAll('.carousel-slide');
            const pdfBtn = document.querySelectorAll('.action-btn')[1];
            const originalText = pdfBtn.textContent;
            
            try {
                pdfBtn.disabled = true;
                pdfBtn.textContent = 'Creating PDF...';
                
                const { jsPDF } = window.jspdf;
                // Create square PDF (1:1 aspect ratio)
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [210, 210] // Square format (210mm x 210mm)
                });
                
                for (let i = 0; i < slides.length; i++) {
                    const slide = slides[i];
                    
                    try {
                        // Create high-quality canvas for PDF
                        const canvas = await html2canvas(slide, {
                            backgroundColor: '#ffffff',
                            scale: 2,
                            width: 400,
                            height: 400,
                            useCORS: true,
                            logging: false,
                            allowTaint: true,
                            onclone: (clonedDoc) => {
                                const clonedSlide = clonedDoc.querySelector(`[data-slide-index="${i}"]`);
                                if (clonedSlide) {
                                    clonedSlide.style.fontFamily = 'Inter, system-ui, -apple-system, sans-serif';
                                    clonedSlide.style.borderRadius = '0px';
                                    clonedSlide.style.overflow = 'visible';
                                }
                            }
                        });
                        
                        const imgData = canvas.toDataURL('image/png', 1.0);
                        
                        if (i > 0) {
                            pdf.addPage();
                        }
                        
                        // Calculate dimensions to fill the entire square page
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        
                        // Fill entire square page (no margins needed since PDF is already square)
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight, '', 'FAST');
                        
                        // Update progress
                        pdfBtn.textContent = `Processing ${i + 1}/${slides.length} slides...`;
                        
                    } catch (error) {
                        console.error(`Error processing slide ${i + 1} for PDF:`, error);
                    }
                }
                
                // Add metadata
                pdf.setProperties({
                    title: 'LinkedIn Carousel by Growwh',
                    subject: currentCarouselData.slides[0].title,
                    author: 'Growwh LinkedIn Carousel Generator',
                    creator: 'Growwh'
                });
                
                // Save PDF
                const topic = currentCarouselData.slides[0].title.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 30);
                pdf.save(`LinkedIn-Carousel-${topic}.pdf`);
                
                showToast('üìÑ PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF creation error:', error);
                showToast('Failed to create PDF. Please try again.', 'error');
            } finally {
                pdfBtn.disabled = false;
                pdfBtn.textContent = originalText;
            }
        }
        
        function copyCaption() {
            if (!currentCarouselData) {
                showToast('No caption available to copy.', 'error');
                return;
            }
            
            const captionText = document.getElementById('captionText').textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(captionText).then(() => {
                    showToast('üìã Caption copied to clipboard!', 'success');
                    
                    // Visual feedback on the caption
                    const captionElement = document.getElementById('captionText');
                    captionElement.style.background = '#dcfce7';
                    captionElement.style.borderColor = '#16a34a';
                    setTimeout(() => {
                        captionElement.style.background = 'white';
                        captionElement.style.borderColor = '#e2e8f0';
                    }, 1500);
                    
                }).catch(err => {
                    console.error('Failed to copy caption:', err);
                    fallbackCopyCaption(captionText);
                });
            } else {
                fallbackCopyCaption(captionText);
            }
        }
        
        function fallbackCopyCaption(text) {
            // Fallback method for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('üìã Caption copied to clipboard!', 'success');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showToast('Unable to copy caption. Please select and copy manually.', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to generate
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!isGenerating) {
                    generateCarousel();
                }
            }
            
            // Escape to clear results
            if (e.key === 'Escape' && currentCarouselData) {
                clearResults();
            }
        });
        
        // Auto-save form data to prevent loss
        const formFields = ['topic', 'tone', 'industry', 'username', 'slides', 'audience', 'keyPoints'];
        
        // Load saved data on page load
        window.addEventListener('load', function() {
            formFields.forEach(fieldId => {
                const savedValue = localStorage.getItem(`carousel_${fieldId}`);
                if (savedValue) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = savedValue;
                    }
                }
            });
        });
        
        // Save form data on input
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    localStorage.setItem(`carousel_${fieldId}`, this.value);
                });
            }
        });
        
        // Clear saved data when form is cleared
        function clearSavedData() {
            formFields.forEach(fieldId => {
                localStorage.removeItem(`carousel_${fieldId}`);
            });
        }
        
        // Enhanced error handling for network issues
        window.addEventListener('online', function() {
            showToast('‚úÖ You\'re back online!', 'success');
        });
        
        window.addEventListener('offline', function() {
            showToast('üì° You appear to be offline. Please check your connection.', 'error');
        });
        
        // Prevent form submission on Enter key (except in textarea)
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
                e.preventDefault();
            }
        });
        
        // Add helpful tooltips and tips
        const helpTexts = {
            topic: "Be specific! Example: '5 Digital Marketing Trends That Will Dominate 2025'",
            keyPoints: "Add specific data, examples, or unique insights you want to include",
            audience: "Think about who will benefit most from this content"
        };
        
        Object.keys(helpTexts).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.setAttribute('title', helpTexts[fieldId]);
            }
        });
    </script>
</body>
</html>
