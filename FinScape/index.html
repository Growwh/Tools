<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start-up Runway Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F9FAFB; }
        h1, h2, h3, h4, h5, h6, .font-inter { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-field { transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        .input-field:focus { border-color: #693ab7; box-shadow: 0 0 0 3px rgba(105, 58, 183, 0.1); outline: none; }
        .btn-primary { background-color: #693ab7; transition: all 0.2s ease; }
        .btn-primary:hover { background-color: #5a319a; transform: translateY(-1px); }
        .btn-secondary { background-color: #e5e7eb; color: #374151; transition: all 0.2s ease; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #693ab7; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
             <div class="inline-block p-3 mb-4 bg-gradient-to-br from-[#8664cf] to-[#693ab7] rounded-xl shadow-lg"><svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/><line x1="3" y1="11" x2="21" y2="11" stroke="currentColor" stroke-width="2"/><line x1="8" y1="4" x2="8" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="16" y1="4" x2="16" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><text x="12" y="18" text-anchor="middle" fill="currentColor" font-size="7" font-family="Arial">&#8377;</text></svg></div>
            <h1 class="text-3xl md:text-4xl font-black bg-gradient-to-r from-[#693ab7] to-[#270a47] bg-clip-text text-transparent mb-2">Start-up Runway Calculator</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">Visually compare "what if" scenarios to understand your startup's financial future.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Baseline Financials</h2>
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-700">Cash on Hand (₹)</label><input type="number" id="cashOnHand" value="5000000" class="w-full mt-1 p-2 input-field rounded-md"></div>
                        <div><label class="text-sm font-medium text-gray-700">Monthly Expenses (₹)</label><input type="number" id="monthlyExpenses" value="500000" class="w-full mt-1 p-2 input-field rounded-md"></div>
                        <div><label class="text-sm font-medium text-gray-700">Monthly Revenue (₹)</label><input type="number" id="monthlyRevenue" value="100000" class="w-full mt-1 p-2 input-field rounded-md"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" id="explorer-title">Scenario Explorer</h2>
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-700">Scenario Name</label><input type="text" id="scenarioName" placeholder="e.g., Aggressive Growth" class="w-full mt-1 p-2 input-field rounded-md"></div>
                        <div><label class="text-sm font-medium text-gray-700">Revenue Growth (%/month)</label><input type="number" id="revenueGrowth" value="10" class="w-full mt-1 p-2 input-field rounded-md"></div>
                        <div><label class="text-sm font-medium text-gray-700">Additional Monthly Costs (₹)</label><input type="number" id="expenseChange" value="0" class="w-full mt-1 p-2 input-field rounded-md"></div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Funding Events</label>
                            <div id="funding-events-container" class="space-y-2 mt-1"></div>
                            <button id="add-funding-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold mt-2">+ Add Funding</button>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col space-y-3">
                        <button id="scenario-action-btn" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Add & Compare Scenario</button>
                        <button id="resetBtn" class="w-full btn-secondary font-bold py-2 px-4 rounded-lg">Reset All</button>
                    </div>
                </div>
                <div id="scenario-cards-container" class="space-y-3"></div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                 <div>
                    <div class="flex justify-end items-center gap-x-3 text-xs text-gray-500 mb-2">
                        <span>Status Key:</span>
                        <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-green-500 mr-1.5"></div>Sustainable</span>
                        <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-orange-500 mr-1.5"></div>High Burn</span>
                        <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></div>Needs Action</span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-xl card-shadow text-center"><p class="text-sm text-gray-500">Baseline Runway</p><p id="runway-months" class="text-3xl font-bold text-indigo-600">--</p></div>
                        <div class="bg-white p-4 rounded-xl card-shadow text-center"><p class="text-sm text-gray-500">Baseline Zero Cash</p><p id="zero-cash-date" class="text-xl font-bold text-red-600">--</p></div>
                        <div class="bg-white p-4 rounded-xl card-shadow text-center"><p class="text-sm text-gray-500">Baseline Profitability</p><p id="profitability-date" class="font-bold text-xl text-gray-800">--</p></div>
                    </div>
                    <div id="kpi-summary" class="text-center text-sm text-gray-600 mt-3 px-2"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold text-gray-800">Cash Balance Projection</h2>
                        <div class="flex items-center space-x-2"><button id="toggleTableBtn" class="btn-secondary text-xs font-bold py-2 px-3 rounded-lg flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span>Data</span></button><button id="downloadPdfBtn" class="btn-secondary text-xs font-bold py-2 px-3 rounded-lg flex items-center space-x-2 disabled:opacity-50" disabled><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>PDF</span></button></div>
                    </div>
                    <div id="chart-controls" class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm mb-4 border-t border-b py-2"></div>
                    <div><canvas id="runwayChart"></canvas></div>
                    <div id="table-container" class="hidden mt-4 max-h-64 overflow-y-auto"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl card-shadow">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">AI Analysis</h2>
                        <button id="generateAIBtn" class="btn-primary text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 disabled:opacity-50" disabled><span id="aiBtnText">Generate AI Analysis</span><div id="aiLoadingSpinner" class="loading-spinner hidden"></div></button>
                    </div>
                    <div id="ai-insights" class="space-y-4"><p class="text-gray-500">Add scenarios to compare and generate AI-powered insights.</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const { jsPDF } = window.jspdf;
        const inputs = { cashOnHand: document.getElementById('cashOnHand'), monthlyExpenses: document.getElementById('monthlyExpenses'), monthlyRevenue: document.getElementById('monthlyRevenue'), revenueGrowth: document.getElementById('revenueGrowth'), expenseChange: document.getElementById('expenseChange'), scenarioName: document.getElementById('scenarioName') };
        const kpi = { runwayMonths: document.getElementById('runway-months'), zeroCashDate: document.getElementById('zero-cash-date'), profitabilityDate: document.getElementById('profitability-date'), kpiSummary: document.getElementById('kpi-summary') };
        const scenarioActionBtn = document.getElementById('scenario-action-btn'), resetBtn = document.getElementById('resetBtn'), generateAIBtn = document.getElementById('generateAIBtn'), downloadPdfBtn = document.getElementById('downloadPdfBtn'), toggleTableBtn = document.getElementById('toggleTableBtn'), addFundingBtn = document.getElementById('add-funding-btn');
        const aiBtnText = document.getElementById('aiBtnText'), aiLoadingSpinner = document.getElementById('aiLoadingSpinner'), aiInsights = document.getElementById('ai-insights');
        const chartCanvas = document.getElementById('runwayChart'), tableContainer = document.getElementById('table-container'), scenarioCardsContainer = document.getElementById('scenario-cards-container'), explorerTitle = document.getElementById('explorer-title'), fundingEventsContainer = document.getElementById('funding-events-container'), chartControls = document.getElementById('chart-controls');
        
        let scenarios = [], runwayChartInstance = null, editingScenarioId = null;
        const SIMULATION_MONTHS = 24, CHART_COLORS = ['#374151', '#693ab7', '#D946EF', '#10B981', '#F59E0B', '#EF4444'];
        
        function calculateScenario(params) { let cash = params.cashOnHand, revenue = params.monthlyRevenue, expenses = params.monthlyExpenses; const monthlyData = [{ month: 0, cash }]; let runwayMonths = SIMULATION_MONTHS, profitabilityMonth = null, ranOutOfCash = false; for (let month = 1; month <= SIMULATION_MONTHS; month++) { revenue *= (1 + params.revenueGrowth / 100); const fundingEvent = params.fundings.find(f => f.month === month); if (fundingEvent) cash += fundingEvent.amount; cash -= (expenses + params.expenseChange - revenue); if (cash <= 0 && !ranOutOfCash) { runwayMonths = month; ranOutOfCash = true; } if (revenue > (expenses + params.expenseChange) && profitabilityMonth === null) profitabilityMonth = month; monthlyData.push({ month, cash }); } return { id: params.id || Date.now(), name: params.name, runwayMonths, profitabilityMonth, ranOutOfCash, monthlyData, params }; }
        function updateDashboard() { renderScenarioCards(); updateChart(); renderHtmlTable(); generateAIBtn.disabled = scenarios.length <= 1; downloadPdfBtn.disabled = scenarios.length === 0 || !runwayChartInstance; }
        
        function updateBaselineKpis() {
            const baselineResult = scenarios.find(s => s.name === 'Baseline');
            if (!baselineResult) return;
            const zeroDate = new Date(); zeroDate.setMonth(zeroDate.getMonth() + baselineResult.runwayMonths);
            kpi.zeroCashDate.textContent = zeroDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            kpi.profitabilityDate.textContent = baselineResult.profitabilityMonth ? `In ${baselineResult.profitabilityMonth} months` : 'Not Profitable';

            if (baselineResult.ranOutOfCash) {
                kpi.runwayMonths.textContent = `${baselineResult.runwayMonths} months`;
                kpi.zeroCashDate.className = 'text-xl font-bold text-red-500';
                kpi.kpiSummary.innerHTML = `Your baseline scenario is <strong class="text-red-600">burning cash quickly</strong> and will run out of money in approximately ${baselineResult.runwayMonths} months.`;
            } else {
                kpi.runwayMonths.textContent = `> ${SIMULATION_MONTHS} months`;
                if(baselineResult.profitabilityMonth) {
                    kpi.zeroCashDate.className = 'text-xl font-bold text-green-500';
                    kpi.kpiSummary.innerHTML = `Your baseline scenario is <strong class="text-green-600">sustainable</strong> and is projected to become profitable in ${baselineResult.profitabilityMonth} months.`;
                } else {
                    kpi.zeroCashDate.className = 'text-xl font-bold text-orange-500';
                    kpi.kpiSummary.innerHTML = `Your baseline has a long runway but is on a <strong class="text-orange-500">high-burn trajectory</strong> without reaching profitability.`;
                }
            }
        }
        
        function updateChart() { const visibleScenarios = scenarios.filter(s => document.getElementById(`check-${s.id}`)?.checked); const showCurrent = document.getElementById('toggleCurrent')?.checked; let allChartData = [...visibleScenarios]; if (showCurrent) allChartData.push(calculateScenario(getCurrentScenarioParams())); const datasets = allChartData.map((scenario) => ({ label: scenario.name, data: scenario.monthlyData.map(d => d.cash), borderColor: CHART_COLORS[scenarios.findIndex(s => s.id === scenario.id) % CHART_COLORS.length] || '#A855F7', tension: 0.1, fill: false, borderWidth: scenario.name === 'Current Scenario' ? 3 : 2, borderDash: scenario.name === 'Current Scenario' ? [5, 5] : [] })); const chartData = { labels: Array.from({ length: SIMULATION_MONTHS + 1 }, (_, i) => `M${i}`), datasets }; if (runwayChartInstance) { runwayChartInstance.data = chartData; runwayChartInstance.update(); } else { runwayChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'line', data: chartData, options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { ticks: { callback: (value) => `₹${new Intl.NumberFormat('en-IN', { maximumSignificantDigits: 3 }).format(value/100000)}L` } } } } }); } }
        function renderControls() { const savedScenarioControls = scenarios.map(s => `<div class="flex items-center"><input type="checkbox" id="check-${s.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><label for="check-${s.id}" class="ml-2 text-gray-700">${s.name}</label></div>`).join(''); chartControls.innerHTML = `<div class="flex items-center font-semibold"><label class="toggle-switch"><input type="checkbox" id="toggleCurrent" checked><span class="slider"></span></label><label for="toggleCurrent" class="ml-2 text-gray-700">Current Scenario</label></div>${savedScenarioControls}`; }
        function renderScenarioCards() { scenarioCardsContainer.innerHTML = scenarios.slice(1).map(s => `<div class="bg-gray-100 p-3 rounded-lg flex justify-between items-center text-sm"><span class="font-semibold text-gray-700">${s.name}</span><div class="space-x-2"><button class="edit-btn text-blue-600 hover:text-blue-800 font-medium" data-id="${s.id}">Edit</button><button class="delete-btn text-red-600 hover:text-red-800 font-medium" data-id="${s.id}">Delete</button></div></div>`).join(''); }
        function renderHtmlTable() { const allData = scenarios; const headers = allData.map(s => `<th>${s.name}</th>`).join(''); let rows = ''; for (let i = 0; i <= SIMULATION_MONTHS; i++) { const cells = allData.map(s => `<td>₹ ${new Intl.NumberFormat('en-IN').format(Math.round(s.monthlyData[i].cash))}</td>`).join(''); rows += `<tr><td class="font-bold">M${i}</td>${cells}</tr>`; } tableContainer.innerHTML = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th>Month</th>${headers}</tr></thead><tbody>${rows}</tbody></table>`; }
        function getBaselineInputs() { return { cashOnHand: parseFloat(inputs.cashOnHand.value) || 0, monthlyExpenses: parseFloat(inputs.monthlyExpenses.value) || 0, monthlyRevenue: parseFloat(inputs.monthlyRevenue.value) || 0 }; }
        function getCurrentScenarioParams() { const base = getBaselineInputs(); const name = inputs.scenarioName.value.trim() || 'Current Scenario'; const fundings = Array.from(fundingEventsContainer.children).map(row => ({ amount: parseFloat(row.querySelector('.funding-amount').value) || 0, month: parseInt(row.querySelector('.funding-month').value) || 0, })).filter(f => f.amount > 0 && f.month > 0); return { ...base, name, fundings, revenueGrowth: parseFloat(inputs.revenueGrowth.value) || 0, expenseChange: parseFloat(inputs.expenseChange.value) || 0 }; }
        [inputs.cashOnHand, inputs.monthlyExpenses, inputs.monthlyRevenue].forEach(input => input.addEventListener('input', () => { initialize(); }));
        Object.values(inputs).forEach(input => input.addEventListener('input', updateDashboard));
        fundingEventsContainer.addEventListener('input', updateDashboard);
        chartControls.addEventListener('change', updateChart);
        
        scenarioActionBtn.addEventListener('click', () => { if (editingScenarioId) { const index = scenarios.findIndex(s => s.id === editingScenarioId); if (index > -1) { const updatedParams = getCurrentScenarioParams(); updatedParams.name = scenarios[index].name; scenarios[index] = calculateScenario({ ...updatedParams, id: editingScenarioId }); } exitEditMode(); } else { const scenarioParams = getCurrentScenarioParams(); if (scenarioParams.name === 'Current Scenario') scenarioParams.name = `Scenario #${scenarios.length}`; scenarios.push(calculateScenario(scenarioParams)); resetExplorerInputs(); } renderControls(); updateDashboard(); });
        scenarioCardsContainer.addEventListener('click', e => { if (e.target.classList.contains('edit-btn')) { const id = Number(e.target.dataset.id); const scenarioToEdit = scenarios.find(s => s.id === id); if (scenarioToEdit) enterEditMode(scenarioToEdit); } if (e.target.classList.contains('delete-btn')) { const id = Number(e.target.dataset.id); scenarios = scenarios.filter(s => s.id !== id); if (editingScenarioId === id) exitEditMode(); renderControls(); updateDashboard(); } });
        resetBtn.addEventListener('click', () => { if (runwayChartInstance) { runwayChartInstance.destroy(); runwayChartInstance = null; } resetExplorerInputs(); aiInsights.innerHTML = `<p class="text-gray-500">Add scenarios to compare and generate AI-powered insights.</p>`; initialize(); });
        toggleTableBtn.addEventListener('click', () => tableContainer.classList.toggle('hidden'));
        addFundingBtn.addEventListener('click', () => addFundingRow());
        fundingEventsContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-funding-btn')) { e.target.closest('.funding-row').remove(); updateDashboard(); } });
        function addFundingRow(funding = { amount: '', month: '' }) { const row = document.createElement('div'); row.className = 'funding-row flex items-center space-x-2'; row.innerHTML = `<input type="number" class="funding-amount w-1/2 p-1 input-field rounded-md text-sm" placeholder="Amount (₹)" value="${funding.amount}"><input type="number" class="funding-month w-1/3 p-1 input-field rounded-md text-sm" placeholder="Month #" value="${funding.month}"><button type="button" class="remove-funding-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>`; fundingEventsContainer.appendChild(row); }

        downloadPdfBtn.addEventListener('click', async () => {
            try {
                // Show loading state
                downloadPdfBtn.disabled = true;
                downloadPdfBtn.innerHTML = '<div class="loading-spinner"></div><span>Generating...</span>';
                
                // Wait for chart to be fully rendered
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Verify chart exists and is rendered
                if (!runwayChartInstance || !runwayChartInstance.canvas) {
                    throw new Error('Chart not properly initialized');
                }
                
                // Verify autoTable plugin is available
                if (typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
                    console.warn('AutoTable plugin not found, using basic table');
                }
                
                const doc = new jsPDF();
                
                // Use simple approach - just force the ₹ symbol with proper encoding
                doc.setFont('helvetica', 'normal');
                
                // Function to format currency with ₹ symbol using escape sequence
                const formatCurrencyForPDF = (amount) => {
                    // Use escape sequence for Rupee symbol
                    const rupeeSymbol = 'Rs.'; // Unicode for ₹
                    return `${rupeeSymbol} ${new Intl.NumberFormat('en-IN', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(Math.round(amount))}`;
                };
                
                // Add title and header
                doc.setFontSize(18);
                doc.text("Financial Health Analysis", 14, 20);
                
                doc.setFontSize(10);
                doc.text(`Report generated on: ${new Date().toLocaleDateString()}`, 14, 28);
                
                // Add chart image
                let chartBase64;
                try {
                    chartBase64 = runwayChartInstance.toBase64Image('image/png', 1);
                } catch (error) {
                    console.warn('Chart image capture failed:', error);
                    doc.setFontSize(12);
                    doc.text('Chart unavailable - please ensure the chart is visible', 14, 50);
                    chartBase64 = null;
                }
                
                if (chartBase64) {
                    doc.addImage(chartBase64, 'PNG', 14, 35, 180, 90);
                }
                
                // Get visible scenarios for the table
                const visibleScenarios = scenarios.filter(s => {
                    const checkbox = document.getElementById(`check-${s.id}`);
                    return checkbox ? checkbox.checked : true;
                });
                
                if (visibleScenarios.length === 0) {
                    doc.setFontSize(12);
                    doc.text('No scenarios to display', 14, chartBase64 ? 140 : 60);
                } else {
                    // Create table data
                    const tableHead = ['Month', ...visibleScenarios.map(s => s.name)];
                    const tableBody = [];
                    
                    for (let i = 0; i <= SIMULATION_MONTHS; i++) {
                        const row = [
                            `M${i}`,
                            ...visibleScenarios.map(s => {
                                const cash = s.monthlyData[i]?.cash || 0;
                                return formatCurrencyForPDF(cash);
                            })
                        ];
                        tableBody.push(row);
                    }
                    
                    // Add table using autoTable if available, otherwise fallback
                    const startY = chartBase64 ? 135 : 45;
                    
                    if (typeof doc.autoTable === 'function') {
                        doc.autoTable({
                            head: [tableHead],
                            body: tableBody,
                            startY: startY,
                            styles: {
                                fontSize: 8,
                                cellPadding: 2
                            },
                            headStyles: {
                                fillColor: [105, 58, 183], // Purple color
                                textColor: [255, 255, 255],
                                fontSize: 9
                            },
                            alternateRowStyles: {
                                fillColor: [248, 249, 250]
                            },
                            margin: { left: 14, right: 14 }
                        });
                    } else {
                        // Fallback: Simple text-based table
                        doc.setFontSize(8);
                        let currentY = startY;
                        const lineHeight = 4;
                        
                        // Header
                        doc.setFont('helvetica', 'bold');
                        doc.text(tableHead.join('  |  '), 14, currentY);
                        currentY += lineHeight;
                        
                        // Body (show first 10 rows to avoid overflow)
                        doc.setFont('helvetica', 'normal');
                        tableBody.slice(0, 10).forEach(row => {
                            doc.text(row.join('  |  '), 14, currentY);
                            currentY += lineHeight;
                        });
                    }
                }
                
                // Add summary section
                const baselineScenario = scenarios.find(s => s.name === 'Baseline');
                if (baselineScenario) {
                    const summaryY = doc.internal.pageSize.getHeight() - 40;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Key Insights:', 14, summaryY);
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    let insights = [];
                    
                    if (baselineScenario.ranOutOfCash) {
                        insights.push(`• Baseline runway: ${baselineScenario.runwayMonths} months`);
                    } else {
                        insights.push(`• Baseline runway: > ${SIMULATION_MONTHS} months`);
                    }
                    
                    if (baselineScenario.profitabilityMonth) {
                        insights.push(`• Profitability expected in: ${baselineScenario.profitabilityMonth} months`);
                    } else {
                        insights.push('• Profitability not achieved within simulation period');
                    }
                    
                    insights.push(`• Total scenarios analyzed: ${scenarios.length}`);
                    
                    insights.forEach((insight, index) => {
                        doc.text(insight, 14, summaryY + 8 + (index * 5));
                    });
                }
                
                // Add footer to all pages
                const addFooterToAllPages = () => {
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        const pageHeight = doc.internal.pageSize.getHeight();
                        doc.setFontSize(8);
                        doc.setTextColor(105, 58, 183); // #693ab7 color for Growwh.com
                        const footerText = 'Powered by Growwh.com';
                        const textWidth = doc.getTextWidth(footerText);
                        const centerX = (doc.internal.pageSize.getWidth() - textWidth) / 2;
                        doc.text(footerText, centerX, pageHeight - 10);
                        doc.link(centerX, pageHeight - 12, textWidth, 5, { url: 'https://growwh.com' });
                    }
                };
                
                // Call footer function after all content is added
                addFooterToAllPages();
                
                // Save the PDF
                doc.save('financial_health_analysis.pdf');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF: ' + error.message);
            } finally {
                // Reset button state
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>PDF</span>';
            }
        });

        generateAIBtn.addEventListener('click', async () => { if (scenarios.length < 2) return; aiBtnText.textContent = 'Analyzing...'; aiLoadingSpinner.classList.remove('hidden'); generateAIBtn.disabled = true; const promptData = scenarios.map(s => ({ name: s.name, runway: s.ranOutOfCash ? `${s.runwayMonths}mo` : `>${SIMULATION_MONTHS}mo`, profitability: s.profitabilityMonth ? `in ${s.profitabilityMonth}mo` : `>${SIMULATION_MONTHS}mo`, inputs: `Growth:${s.params.revenueGrowth}%, Costs:₹${s.params.expenseChange}, Fundings:${s.params.fundings.length}` })); const prompt = `You are a startup financial analyst. Analyze these scenarios. Respond ONLY with a valid JSON object like this: {"summary": "High-level strategic summary.", "quantitativeRisks": ["Risk with numbers, e.g., 'Scenario X has only 3 months runway'"], "qualitativeRisks": ["Strategic risk, e.g., 'Over-reliance on funding'"], "opportunities": ["Potential upside, e.g., 'Aggressive growth could capture market'"], "recommendation": "Final suggested action."}. Do not add any text before or after the JSON. Data: ${JSON.stringify(promptData)}`; 
            try { 
                    
                const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent", {
                    method: "POST",
                    headers: {
                        "x-goog-api-key": `AIzaSyDrZLC0L7QzD1slUQhvCGa6DuE9hFskqJo`, // <-- make sure API_KEY is defined
                        "Content-Type": "application/json"
                    },
                    
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
            
                if (!response.ok) throw new Error('API request failed');

                const raw = await response.json();
                
                let text = raw.candidates[0].content.parts[0].text.trim();
                text = text.replace(/```json|```/g, "").trim();
                
                displayAIAnalysis(text); 
                
            }
            
            catch (error) { 
                    
                    aiInsights.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-lg">Error: ${error.message}</div>`; 

            } 
            
            finally {
                    aiBtnText.textContent = 'Generate AI Analysis';
                    aiLoadingSpinner.classList.add('hidden');
                    generateAIBtn.disabled = false;
                } 
            });
        
        function initialize() { scenarios = []; const baselineParams = { ...getBaselineInputs(), name: 'Baseline', revenueGrowth: 0, expenseChange: 0, fundings: [] }; scenarios.push(calculateScenario(baselineParams)); updateBaselineKpis(); renderControls(); updateDashboard(); }
        function resetExplorerInputs() { inputs.scenarioName.value = ''; inputs.revenueGrowth.value = '10'; inputs.expenseChange.value = '0'; fundingEventsContainer.innerHTML = ''; }
        function enterEditMode(scenario) { editingScenarioId = scenario.id; explorerTitle.textContent = `Editing: ${scenario.name}`; inputs.scenarioName.value = scenario.name; inputs.scenarioName.disabled = true; inputs.revenueGrowth.value = scenario.params.revenueGrowth; inputs.expenseChange.value = scenario.params.expenseChange; fundingEventsContainer.innerHTML = ''; scenario.params.fundings.forEach(addFundingRow); scenarioActionBtn.textContent = 'Update Scenario'; }
        function exitEditMode() { editingScenarioId = null; explorerTitle.textContent = 'Scenario Explorer'; scenarioActionBtn.textContent = 'Add & Compare Scenario'; inputs.scenarioName.disabled = false; resetExplorerInputs(); }
        function displayAIAnalysis(text) { try { const jsonMatch = text.match(/\{[\s\S]*\}/); if (!jsonMatch) throw new Error("No JSON object found."); const data = JSON.parse(jsonMatch[0]); aiInsights.innerHTML = `<div><h4 class="font-bold text-gray-800 flex items-center mb-2"><svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Summary</h4><p class="text-gray-600 pl-7">${data.summary || 'N/A'}</p></div><div><h4 class="font-bold text-gray-800 flex items-center mb-2"><svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Key Risks</h4><ul class="list-disc list-inside text-gray-600 space-y-1 pl-7">${(data.quantitativeRisks || []).concat(data.qualitativeRisks || []).map(risk => `<li>${risk}</li>`).join('') || '<li>None identified.</li>'}</ul></div><div><h4 class="font-bold text-gray-800 flex items-center mb-2"><svg class="w-5 h-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Opportunities</h4><ul class="list-disc list-inside text-gray-600 space-y-1 pl-7">${(data.opportunities || []).map(opp => `<li>${opp}</li>`).join('') || '<li>None identified.</li>'}</ul></div><div><h4 class="font-bold text-gray-800 flex items-center mb-2"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Recommendation</h4><p class="text-gray-600 pl-7">${data.recommendation || 'N/A'}</p></div>`; } catch (error) { aiInsights.innerHTML = `<div class="p-4 bg-yellow-50 rounded-lg"><h4 class="font-bold text-yellow-800">AI Response (Raw Text)</h4><p class="text-sm text-yellow-700 mt-2 whitespace-pre-wrap">${text}</p></div>`; } }
        initialize();
    </script>
</body>
</html>
