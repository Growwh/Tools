<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimal Inventory Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F9FAFB; }
        h1, h2, h3, h4, h5, h6, .font-inter { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-field { transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        .input-field:focus { border-color: #693ab7; box-shadow: 0 0 0 3px rgba(105, 58, 183, 0.1); outline: none; }
        .btn-primary { background-color: #693ab7; transition: all 0.2s ease; }
        .btn-primary:hover { background-color: #5a319a; transform: translateY(-1px); }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-group .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .info-group:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <div class="inline-block p-3 mb-4 bg-gradient-to-br from-[#8664cf] to-[#693ab7] rounded-xl shadow-lg"><svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg></div>
            <h1 class="text-3xl md:text-4xl font-black bg-gradient-to-r from-[#693ab7] to-[#270a47] bg-clip-text text-transparent mb-2">Optimal Inventory Calculator</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">Minimize costs and prevent stockouts with an advanced inventory model.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Input Parameters</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center">Product Cost per Unit (₹)
                                <div class="info-group relative ml-2"><svg class="w-4 h-4 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10 -translate-x-1/2 left-1/2">The purchase price or manufacturing cost of a single unit of your product.</div></div>
                            </label>
                            <input type="number" id="productCost" value="400" class="w-full mt-1 p-2 input-field rounded-md">
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center">Monthly Ordering Expenses (₹)
                               <div class="info-group relative ml-2"><svg class="w-4 h-4 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10 -translate-x-1/2 left-1/2">Total fixed monthly costs related to placing orders (e.g., salaries of procurement staff, admin costs).</div></div>
                            </label>
                            <input type="number" id="orderingExpenses" value="20000" class="w-full mt-1 p-2 input-field rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center">Monthly Warehousing Cost (₹)
                               <div class="info-group relative ml-2"><svg class="w-4 h-4 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10 -translate-x-1/2 left-1/2">Total monthly cost for storing all your inventory (rent, utilities, insurance, staff).</div></div>
                            </label>
                            <input type="number" id="warehousingCost" value="10000" class="w-full mt-1 p-2 input-field rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center">Annual Demand (Units)
                               <div class="info-group relative ml-2"><svg class="w-4 h-4 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10 -translate-x-1/2 left-1/2">The total number of units you expect to sell in one year.</div></div>
                            </label>
                            <input type="number" id="annualDemand" value="12000" class="w-full mt-1 p-2 input-field rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center">Maximum Lead Time (Days)
                               <div class="info-group relative ml-2"><svg class="w-4 h-4 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10 -translate-x-1/2 left-1/2">The longest possible time it takes for an order to arrive from your supplier after you place it.</div></div>
                            </label>
                            <input type="number" id="leadTime" value="15" class="w-full mt-1 p-2 input-field rounded-md">
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-xl card-shadow text-center"><p class="text-sm font-medium text-gray-500">Suggested Order Quantity</p><p id="suggested-quantity" class="text-4xl font-bold text-indigo-600 mt-2">--</p><p class="text-xs text-gray-400">units per order</p></div>
                    <div class="bg-white p-6 rounded-xl card-shadow text-center"><p class="text-sm font-medium text-gray-500">Reorder Point (with Safety Stock)</p><p id="reorder-point" class="text-4xl font-bold text-orange-500 mt-2">--</p><p class="text-xs text-gray-400">units in stock</p></div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Notes & Insights</h2>
                    <div id="dynamic-insights" class="space-y-3 text-sm"></div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl card-shadow">
                     <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-y-2">
                        <h2 class="text-xl font-bold text-gray-800">AI Analysis</h2>
                        <button id="generateAIBtn" class="btn-primary text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2"><span id="aiBtnText">Generate AI Analysis</span><div id="aiLoadingSpinner" class="loading-spinner hidden"></div></button>
                    </div>
                    <div id="ai-insights" class="space-y-4"><p class="text-gray-500 text-sm">Click generate to get a strategic analysis of your inventory plan.</p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputs = { productCost: document.getElementById('productCost'), orderingExpenses: document.getElementById('orderingExpenses'), warehousingCost: document.getElementById('warehousingCost'), annualDemand: document.getElementById('annualDemand'), leadTime: document.getElementById('leadTime') };
        const outputs = { suggestedQuantity: document.getElementById('suggested-quantity'), reorderPoint: document.getElementById('reorder-point'), dynamicInsights: document.getElementById('dynamic-insights'), aiInsights: document.getElementById('ai-insights') };
        const generateAIBtn = document.getElementById('generateAIBtn'), aiBtnText = document.getElementById('aiBtnText'), aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
        
        const SAFETY_MULTIPLIER = 1.5;
        const OPPORTUNITY_COST_FACTOR = 1.1;
        const ITERATIONS = 20;

        function calculateInventory() {
            const P = parseFloat(inputs.productCost.value) || 0;
            const O_monthly = parseFloat(inputs.orderingExpenses.value) || 0;
            const w = parseFloat(inputs.warehousingCost.value) || 0;
            const D = parseFloat(inputs.annualDemand.value) || 0;
            const L = parseFloat(inputs.leadTime.value) || 0;

            if (D === 0) { updateUI(0, 0, 0, false, { P, O_monthly, w, D, L }); return; }

            let Q = D / 12;
            const d = D / 365;
            const ROP = (d * L) * SAFETY_MULTIPLIER;
            let K, G;

            for (let i = 0; i < ITERATIONS; i++) {
                K = (D > 0) ? (O_monthly * 12 * Q) / D : 0;
                const warehousingComponent = (D > 0) ? (w * 12) / D : 0;
                const capitalComponent = (D > 0) ? ((OPPORTUNITY_COST_FACTOR) * (Q / 2 + ROP) * P) / D : 0; // Use Q/2 for average inventory
                G = warehousingComponent + capitalComponent;
                if (G > 0) { Q = Math.sqrt((2 * D * K) / G); } else { Q = Infinity; break; }
            }
            
            let suggestedQ = Q;
            let logicalOverride = false;
            
            if (Q > ROP && ROP > 0) {
                suggestedQ = ROP;
                logicalOverride = true;
            }

            updateUI(Q, ROP, suggestedQ, logicalOverride, { P, O_monthly, w, D, L });
        }
        
        function updateUI(Q, ROP, suggestedQ, logicalOverride, params) {
            outputs.suggestedQuantity.textContent = Math.round(suggestedQ).toLocaleString('en-IN');
            outputs.reorderPoint.textContent = Math.round(ROP).toLocaleString('en-IN');
            
            outputs.dynamicInsights.innerHTML = '';
            const insightsList = [];
            
            insightsList.push({ icon: '💡', text: `To optimize inventory, you should place an order for <strong>${Math.round(suggestedQ).toLocaleString('en-IN')} units</strong> each time your stock level drops to <strong>${Math.round(ROP).toLocaleString('en-IN')} units</strong>.` });

            if (logicalOverride) {
                insightsList.push({ icon: '🧠', text: `Note: The calculated EOQ (${Math.round(Q).toLocaleString('en-IN')} units) was higher than your reorder point. We've suggested ordering your reorder point quantity to prevent overstocking.` });
            }

            const annualOrderingCost = params.O_monthly * 12;
            const annualWarehouseCost = params.w * 12;
            const avgInventoryHeld = (suggestedQ / 2) + ROP;
            const annualCapitalCost = avgInventoryHeld * params.P * (OPPORTUNITY_COST_FACTOR - 1);
            const totalHoldingCost = annualWarehouseCost + annualCapitalCost;

            insightsList.push({ icon: '💰', text: `This plan balances an <strong>Annual Ordering Expense</strong> of <strong>₹${annualOrderingCost.toLocaleString('en-IN')}</strong> with an <strong>Annual Inventory Holding Cost</strong> of <strong>₹${Math.round(totalHoldingCost).toLocaleString('en-IN')}</strong> (Inventory Capital Cost: <strong>₹${Math.round(annualCapitalCost).toLocaleString('en-IN')}</strong> + Inventory Warehousing Cost: <strong>₹${Math.round(annualWarehouseCost).toLocaleString('en-IN')}</strong>).` });

            outputs.dynamicInsights.innerHTML = insightsList.map(item => `<div class="flex items-start"><span class="mr-3 text-lg">${item.icon}</span><p class="text-gray-700">${item.text}</p></div>`).join('');
        }

        Object.values(inputs).forEach(input => input.addEventListener('input', calculateInventory));
        generateAIBtn.addEventListener('click', generateAIAnalysis);
        
        async function generateAIAnalysis() {
            aiBtnText.textContent = 'Analyzing...';
            aiLoadingSpinner.classList.remove('hidden');
            generateAIBtn.disabled = true;

            const P = parseFloat(inputs.productCost.value) || 0;
            const O_monthly = parseFloat(inputs.orderingExpenses.value) || 0;
            const w = parseFloat(inputs.warehousingCost.value) || 0;
            const D = parseFloat(inputs.annualDemand.value) || 0;
            const L = parseFloat(inputs.leadTime.value) || 0;
            
            let Q = D / 12; const d = D / 365; const ROP = (d * L) * SAFETY_MULTIPLIER; let K, G;
            for (let i = 0; i < ITERATIONS; i++) { K = (D > 0) ? (O_monthly * 12 * Q) / D : 0; const wc = (D > 0) ? (w * 12) / D : 0; const cc = (D > 0) ? (OPPORTUNITY_COST_FACTOR * (Q / 2 + ROP) * P) / D : 0; G = wc + cc; if (G > 0) { Q = Math.sqrt((2 * D * K) / G); } else { Q = Infinity; break; } }
            let suggestedQ = Q; if (Q > ROP && ROP > 0) { suggestedQ = ROP; }

            const annualOrderingCost = O_monthly * 12;
            const avgInventoryHeld = (suggestedQ / 2) + ROP;
            const annualCapitalCost = avgInventoryHeld * P * (OPPORTUNITY_COST_FACTOR - 1);
            const totalHoldingCost = (w * 12) + annualCapitalCost;
            
            const prompt = `You are acting as a D2C (Direct-to-Consumer) inventory analyst advising a startup founder. Your goal is to provide precise, actionable, and data-driven insights based on the given inputs and calculated results.
            
            **Input Data:**
            - Product Cost: ₹${P}
            - Annual Demand: ${D.toLocaleString('en-IN')} units
            - Monthly Ordering Expenses: ₹${O_monthly.toLocaleString('en-IN')}
            - Monthly Warehousing Cost: ₹${w.toLocaleString('en-IN')}
            - Max Lead Time: ${L} days

            **Calculated Results:**
            - Suggested Order Quantity: ${Math.round(suggestedQ).toLocaleString('en-IN')} units
            - Reorder Point (with safety stock): ${Math.round(ROP).toLocaleString('en-IN')} units
            - Total Annual Ordering Expenses (Salaries + Admin etc.): ₹${Math.round(annualOrderingCost).toLocaleString('en-IN')}
            - Total Annual Inventory Holding Cost (Capital + Warehousing): ₹${Math.round(totalHoldingCost).toLocaleString('en-IN')}
            - Total Annual Inventory Warehousing Cost: ₹${Math.round(w * 12).toLocaleString('en-IN')}
            - Total Annual Inventory Capital Cost: ₹${Math.round(annualCapitalCost).toLocaleString('en-IN')}

            **Your Task:**
            Using the above, perform a critical financial and operational assessment.
            1. Compute the ratio of Holding Cost to Ordering Cost and interpret whether inventory is being managed efficiently.
            2. Evaluate the Capital Efficiency Score (Low, Medium, High) by analyzing how much capital is tied up in stock relative to product cost and demand.
            3. Highlight the most critical financial or operational risk from this setup.
            4. Provide a single, sharp strategic recommendation that the founder can act on immediately (e.g., change in order frequency, renegotiation with suppliers, adoption of JIT).

            Respond ONLY with a valid JSON object in this structure (no extra text or explanation):
            {
                "capital_efficiency_score": "e.g., Medium",
                "cost_balance_analysis": "Explain ratio of holding vs ordering costs with numbers and interpretation.",
                "key_risk": "Identify the single biggest financial or operational risk from the data.",
                "strategic_recommendation": "One clear, actionable recommendation tailored to the scenario."
            }. Do not add any text before or after the JSON.`;

            try {
                    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent", {
                        method: "POST",
                        headers: {
                            "x-goog-api-key": `AIzaSyDrZLC0L7QzD1slUQhvCGa6DuE9hFskqJo`, // <-- make sure API_KEY is defined
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                    const raw = await response.json();


                    if (!raw?.candidates?.length || !raw.candidates[0]?.content?.parts?.length) {
                        throw new Error("Invalid API response format");
                    }

                    let text = raw.candidates[0].content.parts[0].text.trim();
                    text = text.replace(/```json|```/g, "").trim();
                    
                    displayAIAnalysis(text);

            } catch (error) {
                outputs.aiInsights.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                aiBtnText.textContent = 'Generate AI Analysis';
                aiLoadingSpinner.classList.add('hidden');
                generateAIBtn.disabled = false;
            }
        }
        
        function displayAIAnalysis(text) {
             try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("No JSON object found in the AI response.");
                const data = JSON.parse(jsonMatch[0]);
                outputs.aiInsights.innerHTML = `
                    <div class="flex items-start"><span class="mr-3 text-lg">📈</span><p class="text-gray-700"><strong>Capital Efficiency Score:</strong> <span class="font-semibold text-indigo-600">${data.capital_efficiency_score || 'N/A'}</span></p></div>
                    <div class="flex items-start"><span class="mr-3 text-lg">⚖️</span><p class="text-gray-700"><strong>Cost Balance Analysis:</strong> ${data.cost_balance_analysis || 'N/A'}</p></div>
                    <div class="flex items-start"><span class="mr-3 text-lg">⚠️</span><p class="text-gray-700"><strong>Key Risk:</strong> ${data.key_risk || 'N/A'}</p></div>
                    <div class="flex items-start"><span class="mr-3 text-lg">🚀</span><p class="text-gray-700"><strong>Strategic Recommendation:</strong> ${data.strategic_recommendation || 'N/A'}</p></div>
                `;
            } catch (error) {
                outputs.aiInsights.innerHTML = `<div class="p-4 bg-yellow-50 rounded-lg"><h4 class="font-bold text-yellow-800">AI Response (Raw Text)</h4><p class="text-sm text-yellow-700 mt-2 whitespace-pre-wrap">${text}</p></div>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', calculateInventory);
    </script>
</body>
</html>
